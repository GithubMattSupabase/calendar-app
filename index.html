<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Screenshot to Calendar Event</title>
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg: #0a0a0b;
            --surface: #141416;
            --surface-hover: #1a1a1d;
            --border: #2a2a2e;
            --text: #fafafa;
            --text-muted: #888;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            padding: 30px;
        }
        
        h1 {
            color: var(--text);
            margin-bottom: 8px;
            font-size: 24px;
        }
        
        .subtitle {
            color: var(--text-muted);
            margin-bottom: 25px;
            font-size: 14px;
        }
        
        .section {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.2s;
            background: var(--bg);
            color: var(--text);
        }
        
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        input::placeholder {
            color: var(--text-muted);
        }
        
        .api-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .api-row input {
            flex: 1;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
        }
        
        .status-dot.connected {
            background: var(--success);
        }
        
        .clear-key {
            font-size: 12px;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            margin-left: auto;
        }
        
        .clear-key:hover {
            color: var(--text);
            text-decoration: underline;
        }
        
        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg);
        }
        
        .file-upload:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .file-upload.active {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .file-upload p {
            color: var(--text-muted);
            font-size: 14px;
        }
        
        .preview {
            margin-top: 15px;
            display: none;
        }
        
        .preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
        }
        
        button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            -webkit-appearance: none;
        }
        
        button:hover {
            background: var(--accent-hover);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        button:disabled {
            background: var(--border);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-save {
            width: auto;
            padding: 12px 20px;
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: none;
        }
        
        .result h3 {
            color: var(--text);
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .event-details {
            margin-bottom: 15px;
        }
        
        .event-card {
            background: var(--surface);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }
        
        .event-card h4 {
            color: var(--accent);
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .event-card p {
            margin: 6px 0;
            color: var(--text-muted);
            font-size: 14px;
        }
        
        .event-card strong {
            color: var(--text);
        }
        
        .reminder-box {
            margin-top: 12px;
            padding: 12px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
        }
        
        .reminder-box label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin: 0;
            text-transform: none;
            font-weight: normal;
            font-size: 14px;
            color: var(--text);
            letter-spacing: normal;
        }
        
        .reminder-box input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: var(--warning);
        }
        
        .download-btn {
            background: var(--success);
        }
        
        .download-btn:hover {
            background: #16a34a;
        }
        
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            font-size: 14px;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
            color: var(--text-muted);
        }
        
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 12px;
            }
            
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .api-row {
                flex-direction: column;
            }
            
            .btn-save {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ Calendar Extractor</h1>
        <p class="subtitle">Upload a screenshot, get a calendar file</p>
        
        <div class="section">
            <label>API Key</label>
            <div class="api-row">
                <input type="password" id="apiKey" placeholder="sk-ant-api03-..." />
                <button class="btn-save" id="saveKeyBtn" onclick="saveApiKey()">Save</button>
            </div>
            <div class="api-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Not connected</span>
                <button class="clear-key" id="clearKeyBtn" style="display: none;" onclick="clearApiKey()">Clear</button>
            </div>
        </div>
        
        <div class="section">
            <label>Screenshot</label>
            <div class="file-upload" id="fileUpload">
                <div class="upload-icon">üì∏</div>
                <p><strong>Tap to upload</strong>, drag & drop, or <strong>paste</strong></p>
            </div>
            <input type="file" id="fileInput" accept="image/*,.pdf" />
            <div class="preview" id="preview">
                <img id="previewImg" />
            </div>
        </div>
        
        <button id="analyzeBtn" disabled>Extract Events</button>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing screenshot...</p>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="result" id="result">
            <h3>Events Extracted ‚ú®</h3>
            <div class="event-details" id="eventDetails"></div>
            <button class="download-btn" id="downloadBtn">Download .ics</button>
        </div>
    </div>
    
    <script>
        const fileUpload = document.getElementById('fileUpload');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const previewImg = document.getElementById('previewImg');
        const apiKeyInput = document.getElementById('apiKey');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const result = document.getElementById('result');
        const eventDetails = document.getElementById('eventDetails');
        const downloadBtn = document.getElementById('downloadBtn');
        
        let currentFile = null;
        let eventsData = null;
        const STORAGE_KEY = 'calendar_extractor_api_key';
        
        // Load saved API key on startup
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem(STORAGE_KEY);
            if (savedKey) {
                apiKeyInput.value = savedKey;
                setConnectedState(true);
            }
            updateButtonState();
        });
        
        // API Key management
        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem(STORAGE_KEY, key);
                setConnectedState(true);
            }
        }
        
        function clearApiKey() {
            localStorage.removeItem(STORAGE_KEY);
            apiKeyInput.value = '';
            setConnectedState(false);
            updateButtonState();
        }
        
        function setConnectedState(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const clearKeyBtn = document.getElementById('clearKeyBtn');
            const saveKeyBtn = document.getElementById('saveKeyBtn');
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Connected';
                clearKeyBtn.style.display = 'block';
                saveKeyBtn.textContent = 'Update';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Not connected';
                clearKeyBtn.style.display = 'none';
                saveKeyBtn.textContent = 'Save';
            }
        }
        
        // File upload handling
        fileUpload.addEventListener('click', () => fileInput.click());
        
        fileUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUpload.classList.add('active');
        });
        
        fileUpload.addEventListener('dragleave', () => {
            fileUpload.classList.remove('active');
        });
        
        fileUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUpload.classList.remove('active');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        apiKeyInput.addEventListener('input', updateButtonState);
        
        // Paste from clipboard
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    handleFile(blob);
                    e.preventDefault();
                    break;
                }
            }
        });
        
        function handleFile(file) {
            currentFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                preview.style.display = 'block';
                updateButtonState();
            };
            reader.readAsDataURL(file);
        }
        
        function updateButtonState() {
            analyzeBtn.disabled = !(currentFile && apiKeyInput.value.trim());
        }
        
        analyzeBtn.addEventListener('click', analyzeImage);
        
        async function analyzeImage() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey || !currentFile) return;
            
            loading.style.display = 'block';
            error.style.display = 'none';
            result.style.display = 'none';
            analyzeBtn.disabled = true;
            
            try {
                const base64Data = await fileToBase64(currentFile);
                const mediaType = currentFile.type || 'image/jpeg';
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: mediaType,
                                        data: base64Data
                                    }
                                },
                                {
                                    type: 'text',
                                    text: `Analyze this image and extract ALL event details. If there are multiple events (e.g., outbound and return flights), extract each one separately.

IMPORTANT FOR FLIGHTS: If this is a flight or travel booking:
- Extract departure time and location (with timezone)
- Extract arrival time and location (with timezone) 
- These may be in different timezones (e.g., depart 6:45 AKL, arrive 8:15 SYD)
- If there are multiple flights (outbound + return), create separate entries for each

Return ONLY a JSON object with an array of events like this:

{
  "events": [
    {
      "title": "event title",
      "date": "YYYY-MM-DD",
      "startTime": "HH:MM" (24-hour format),
      "endTime": "HH:MM" (24-hour format),
      "location": "location or route like AKL-SYD",
      "departureTimezone": "IANA timezone for start location (e.g., Pacific/Auckland)",
      "arrivalTimezone": "IANA timezone for end location (e.g., Australia/Sydney)",
      "description": "any additional details like flight number, confirmation code",
      "attendees": ["email1@example.com"],
      "isFlight": true/false
    }
  ]
}

For timezone: Use IANA timezone database names. Common examples:
- Sydney/Melbourne: Australia/Sydney
- Auckland: Pacific/Auckland
- London: Europe/London
- New York: America/New_York
- Los Angeles: America/Los_Angeles
- Singapore: Asia/Singapore
- Tokyo: Asia/Tokyo

If only one event is found, still return it as an array with one item.
Do not include any text outside the JSON object.`
                                }
                            ]
                        }]
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }
                
                const data = await response.json();
                const text = data.content[0].text.trim();
                
                // Extract JSON from response (in case Claude adds any wrapper text)
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('Could not parse event data from response');
                }
                
                const parsedData = JSON.parse(jsonMatch[0]);
                eventsData = parsedData.events || [parsedData]; // Handle both array and single object
                displayEvents(eventsData);
                
            } catch (err) {
                error.textContent = `Error: ${err.message}`;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function displayEvents(events) {
            let html = '';
            
            events.forEach((data, index) => {
                html += `<div class="event-card">`;
                html += `<h4>Event ${index + 1}</h4>`;
                
                if (data.title) html += `<p><strong>Title:</strong> ${data.title}</p>`;
                if (data.date) html += `<p><strong>Date:</strong> ${data.date}</p>`;
                if (data.startTime) {
                    const tzInfo = data.departureTimezone ? ` (${data.departureTimezone})` : '';
                    html += `<p><strong>Departure:</strong> ${data.startTime}${tzInfo}</p>`;
                }
                if (data.endTime) {
                    const tzInfo = data.arrivalTimezone ? ` (${data.arrivalTimezone})` : '';
                    html += `<p><strong>Arrival:</strong> ${data.endTime}${tzInfo}</p>`;
                }
                if (data.location) html += `<p><strong>Location:</strong> ${data.location}</p>`;
                if (data.description) html += `<p><strong>Details:</strong> ${data.description}</p>`;
                if (data.attendees && data.attendees.length > 0) {
                    html += `<p><strong>Attendees:</strong> ${data.attendees.join(', ')}</p>`;
                }
                
                // Add check-in reminder option for flights
                if (data.isFlight) {
                    html += `
                        <div class="reminder-box">
                            <label>
                                <input type="checkbox" class="addReminder" data-event-index="${index}" checked>
                                Add check-in reminder (24 hours before)
                            </label>
                        </div>
                    `;
                }
                
                html += `</div>`;
            });
            
            eventDetails.innerHTML = html;
            result.style.display = 'block';
        }
        
        downloadBtn.addEventListener('click', downloadICS);
        
        function downloadICS() {
            if (!eventsData || eventsData.length === 0) return;
            
            const now = new Date();
            const timestamp = now.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            
            // Get all reminder checkboxes
            const reminderCheckboxes = document.querySelectorAll('.addReminder');
            
            // Build ICS content
            let ics = 'BEGIN:VCALENDAR\r\n';
            ics += 'VERSION:2.0\r\n';
            ics += 'PRODID:-//Calendar Event Extractor//EN\r\n';
            ics += 'CALSCALE:GREGORIAN\r\n';
            ics += 'METHOD:PUBLISH\r\n';
            
            // Add each event
            eventsData.forEach((eventData, index) => {
                const eventDate = eventData.date || now.toISOString().split('T')[0];
                const startTime = eventData.startTime || '09:00';
                let endTime = eventData.endTime || '10:00';
                
                // Timezone offsets (hours from UTC)
                const tzOffsets = {
                    'Pacific/Auckland': 13,  // NZDT (UTC+13 in summer)
                    'Australia/Sydney': 11,  // AEDT (UTC+11 in summer)
                    'Australia/Melbourne': 11,
                    'Australia/Brisbane': 10,
                    'Asia/Singapore': 8,
                    'Asia/Tokyo': 9,
                    'Europe/London': 0,
                    'America/New_York': -5,
                    'America/Los_Angeles': -8,
                };
                
                // If arrival is in a different timezone, convert to departure timezone
                if (eventData.departureTimezone && eventData.arrivalTimezone && 
                    eventData.departureTimezone !== eventData.arrivalTimezone) {
                    const deptOffset = tzOffsets[eventData.departureTimezone] || 0;
                    const arrivalOffset = tzOffsets[eventData.arrivalTimezone] || 0;
                    const offsetDiff = deptOffset - arrivalOffset;
                    
                    // Convert arrival time to departure timezone
                    const [hours, minutes] = endTime.split(':').map(Number);
                    let adjustedHours = hours + offsetDiff;
                    
                    // Handle day rollover
                    if (adjustedHours < 0) adjustedHours += 24;
                    if (adjustedHours >= 24) adjustedHours -= 24;
                    
                    endTime = `${String(adjustedHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                }
                
                const startDateTime = `${eventDate.replace(/-/g, '')}T${startTime.replace(/:/g, '')}00`;
                const endDateTime = `${eventDate.replace(/-/g, '')}T${endTime.replace(/:/g, '')}00`;
                
                const uid = `${timestamp}-${index}@calendar-app`;
                const timezone = eventData.departureTimezone || null;
                
                // Build description with timezone info
                let description = eventData.description || '';
                if (eventData.isFlight && eventData.departureTimezone && eventData.arrivalTimezone && 
                    eventData.departureTimezone !== eventData.arrivalTimezone) {
                    description += (description ? '\n\n' : '') + 
                        `Departure: ${eventData.startTime} ${eventData.departureTimezone}\n` +
                        `Arrival: ${eventData.endTime} ${eventData.arrivalTimezone}`;
                }
                
                // Main event
                ics += 'BEGIN:VEVENT\r\n';
                ics += `UID:${uid}\r\n`;
                ics += `DTSTAMP:${timestamp}\r\n`;
                
                // Always use departure timezone
                if (timezone) {
                    ics += `DTSTART;TZID=${timezone}:${startDateTime}\r\n`;
                    ics += `DTEND;TZID=${timezone}:${endDateTime}\r\n`;
                } else {
                    ics += `DTSTART:${startDateTime}\r\n`;
                    ics += `DTEND:${endDateTime}\r\n`;
                }
                
                ics += `SUMMARY:${eventData.title || 'Event'}\r\n`;
                
                if (eventData.location) {
                    ics += `LOCATION:${eventData.location}\r\n`;
                }
                
                if (description) {
                    ics += `DESCRIPTION:${description.replace(/\n/g, '\\n')}\r\n`;
                }
                
                if (eventData.attendees && eventData.attendees.length > 0) {
                    eventData.attendees.forEach(attendee => {
                        ics += `ATTENDEE;CN=${attendee}:mailto:${attendee}\r\n`;
                    });
                }
                
                ics += 'STATUS:CONFIRMED\r\n';
                ics += 'SEQUENCE:0\r\n';
                ics += 'END:VEVENT\r\n';
                
                // Add check-in reminder if requested for this specific event
                const checkbox = reminderCheckboxes[index];
                if (checkbox && checkbox.checked && eventData.isFlight) {
                    const reminderDate = new Date(eventDate + 'T' + startTime);
                    reminderDate.setHours(reminderDate.getHours() - 24);
                    
                    const reminderDateTime = reminderDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                    const reminderDateOnly = reminderDateTime.split('T')[0];
                    const reminderTimeOnly = reminderDateTime.split('T')[1].substring(0, 6);
                    
                    ics += 'BEGIN:VEVENT\r\n';
                    ics += `UID:${timestamp}-${index}-reminder@calendar-app\r\n`;
                    ics += `DTSTAMP:${timestamp}\r\n`;
                    ics += `DTSTART:${reminderDateOnly}T${reminderTimeOnly}\r\n`;
                    ics += `DTEND:${reminderDateOnly}T${reminderTimeOnly}\r\n`;
                    ics += `SUMMARY:‚è∞ Check in for ${eventData.title || 'flight'}\r\n`;
                    ics += `DESCRIPTION:Time to check in for your flight. Departure at ${eventData.startTime}.\r\n`;
                    
                    ics += 'BEGIN:VALARM\r\n';
                    ics += 'TRIGGER:-PT15M\r\n';
                    ics += 'ACTION:DISPLAY\r\n';
                    ics += `DESCRIPTION:Check in for ${eventData.title || 'flight'}\r\n`;
                    ics += 'END:VALARM\r\n';
                    
                    ics += 'STATUS:CONFIRMED\r\n';
                    ics += 'SEQUENCE:0\r\n';
                    ics += 'END:VEVENT\r\n';
                }
            });
            
            ics += 'END:VCALENDAR\r\n';
            
            // Create download
            const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = eventsData.length === 1 
                ? `${(eventsData[0].title || 'event').replace(/[^a-z0-9]/gi, '_')}.ics`
                : 'events.ics';
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
